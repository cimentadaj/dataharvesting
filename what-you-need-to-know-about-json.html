<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>14 What you need to know about JSON | Data Harvesting with R</title>
<meta name="author" content="Jorge Cimentada">
<meta name="description" content="Most of the content you’ll grab from an API will probably be in JavaScript Object Notation or JSON for short. This is a format that was designed to be easily shared over the internet and is pretty...">
<meta name="generator" content="bookdown 0.26 with bs4_book()">
<meta property="og:title" content="14 What you need to know about JSON | Data Harvesting with R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://cimentadaj.github.io/dataharvesting/what-you-need-to-know-about-json.html">
<meta property="og:description" content="Most of the content you’ll grab from an API will probably be in JavaScript Object Notation or JSON for short. This is a format that was designed to be easily shared over the internet and is pretty...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="14 What you need to know about JSON | Data Harvesting with R">
<meta name="twitter:description" content="Most of the content you’ll grab from an API will probably be in JavaScript Object Notation or JSON for short. This is a format that was designed to be easily shared over the internet and is pretty...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/_Lato-0.4.1/font.css" rel="stylesheet">
<link href="libs/_Roboto%20Mono-0.4.1/font.css" rel="stylesheet">
<link href="libs/_Montserrat-0.4.1/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/str_view-0.1.0/str_view.css" rel="stylesheet">
<script src="libs/str_view-binding-1.4.0/str_view.js"></script><link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
<script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
         (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-99618359-1', 'auto');
     ga('send', 'pageview');

    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h2>
        <a href="index.html" title="">Data Harvesting with R</a>
      </h2>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Welcome</a></li>
<li><a class="" href="introduction-to-webscraping.html"><span class="header-section-number">2</span> Introduction to Webscraping</a></li>
<li><a class="" href="a-primer-on-webscraping.html"><span class="header-section-number">3</span> A primer on Webscraping</a></li>
<li><a class="" href="data-formats-for-webscraping.html"><span class="header-section-number">4</span> Data Formats for Webscraping</a></li>
<li><a class="" href="what-you-need-to-know-about-regular-expressions.html"><span class="header-section-number">5</span> What you need to know about regular expressions</a></li>
<li><a class="" href="what-you-need-to-know-about-xpath.html"><span class="header-section-number">6</span> What you need to know about XPath</a></li>
<li><a class="" href="case-study-scraping-spanish-school-locations-from-the-web.html"><span class="header-section-number">7</span> Case study: scraping Spanish school locations from the web</a></li>
<li><a class="" href="automating-web-scraping-scripts.html"><span class="header-section-number">8</span> Automating Web Scraping Scripts</a></li>
<li><a class="" href="scraping-javascript-based-website.html"><span class="header-section-number">9</span> Scraping JavaScript based website</a></li>
<li><a class="" href="ethical-issues-in-web-scraping.html"><span class="header-section-number">10</span> Ethical issues in Web Scraping</a></li>
<li><a class="" href="introduction-to-rest-apis.html"><span class="header-section-number">11</span> Introduction to REST APIs</a></li>
<li><a class="" href="a-primer-on-apis.html"><span class="header-section-number">12</span> A primer on APIs</a></li>
<li><a class="" href="what-is-a-restful-api.html"><span class="header-section-number">13</span> What is a RESTful API?</a></li>
<li><a class="active" href="what-you-need-to-know-about-json.html"><span class="header-section-number">14</span> What you need to know about JSON</a></li>
<li><a class="" href="case-study-grabbing-data-from-a-public-api.html"><span class="header-section-number">15</span> Case Study: grabbing data from a public API</a></li>
<li><a class="" href="automating-api-programs-real-time-bicycle-data.html"><span class="header-section-number">16</span> Automating API programs: real-time bicycle data</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/cimentadaj/dataharvesting/tree/main/book">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="what-you-need-to-know-about-json" class="section level1" number="14">
<h1>
<span class="header-section-number">14</span> What you need to know about JSON<a class="anchor" aria-label="anchor" href="#what-you-need-to-know-about-json"><i class="fas fa-link"></i></a>
</h1>
<p>Most of the content you’ll grab from an API will probably be in JavaScript Object Notation or JSON for short. This is a format that was designed to be easily shared over the internet and is pretty much the standard for sharing data over APIs. JSON’s are text based and allow you to store all the usual stuff you’re used to such as strings and numbers. However, JSON’s also allow you to use arrays, and more importantly, build complex nested structure.</p>
<p>As always, you might ask yourself, why is this new format important? I’ll skip you the technical boring details and leave with you the three most important points:</p>
<ul>
<li>It’s lightweight and easy to share</li>
<li>It has support in nearly all programming languages</li>
<li>It allows you to make nested relationships and they’re easy to read</li>
</ul>
<p>In this chapter we’ll jump directly to the content that is mostly related to parsing JSON’s in the context of API requests. This means that we won’t be looking at toy examples but rather at a typical response you might get from an API, which has very nested structures. The idea is for users not to have perfect knowledge on JSON’s but rather learn tricks on how to convert it to the format that they’re interested in.</p>
<p>If you want more information on JSON’s in R, be sure to visit Gaston Sanchez’s JSON intro, from which this chapter is very much inspired ( <a href="https://www.gastonsanchez.com/intro2cwd/json.html">https://www.gastonsanchez.com/intro2cwd/json.html</a>)</p>
<p>With theory out of the way, let’s get our hands dirty. Let’s load the package we’ll use in this chapter:</p>
<div class="sourceCode" id="cb295"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://arxiv.org/abs/1403.2805">jsonlite</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/">tibble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></code></pre></div>
<div id="your-first-json-example" class="section level2" number="14.1">
<h2>
<span class="header-section-number">14.1</span> Your first JSON example<a class="anchor" aria-label="anchor" href="#your-first-json-example"><i class="fas fa-link"></i></a>
</h2>
<p>The JSON syntax is very straightforward. You wrap everything in <code><a href="https://rdrr.io/r/base/Paren.html">{}</a></code> and specify data as <code>key:value</code> pairs. For example:</p>
<pre><code>{
  "president": "Parlosi",
  "vicepresident": "Kantos",
  "opposition": "Pitaso"
}</code></pre>
<p>Each <code>key:value</code> needs to be wrapped in quotes (<code>"</code>). In <code>R</code> we can parse JSON’s with several packages. In this book we’ll use <code>jsonlite</code> but feel free to explore other options. Let’s lparse the string we specified before with the function <code>fromJSON</code>:</p>
<div class="sourceCode" id="cb297"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">json_str</span> <span class="op">&lt;-</span> <span class="st">'{
  "president": "Parlosi",
  "vicepresident": "Kantos",
  "opposition": "Pitaso"
}'</span>

<span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">json_str</span><span class="op">)</span></code></pre></div>
<pre><code>## $president
## [1] "Parlosi"
## 
## $vicepresident
## [1] "Kantos"
## 
## $opposition
## [1] "Pitaso"</code></pre>
<p>It parses the key/value pairs as a named list. That’s exactly how yo can think of JSON’s for now. A way to store named arrays. At this point I could show you a few examples of how JSON’s work but it’s pretty much it: <code>key:value</code> pairs. You can write number instead of strings as well but there’s nothing to be gained from this example of JSON at the moment.</p>
<p>It’s inevitable to say that the true deal breaker with JSON’s is the nested nature of the format. Here’s what you can achieve with very simple syntax:</p>
<pre><code>{
    "president": [
        {
            "last_name": "Parlosi",
            "party": "Free thinkers",
            "age": 35
        }
    ],
    "vicepresident": [
        {
            "last_name": "Kantos",
            "party": "Free thinkers",
            "age": 52
        }
    ],
    "opposition": [
        {
            "last_name": "Pitaso",
            "party": "Everyone United",
            "age": 45
        }
    ]
}</code></pre>
<p>Things have taken quite a change here. Let’s stop and discuss these changes. We still have the same <code>key:value</code> pairs (<code>president</code>, etc..) but the value is not only a string or a number but an <strong>array</strong>. So the first <code>key:value</code> pair is:</p>
<pre><code>"president": [
    {
        "last_name": "Parlosi",
        "party": "Free thinkers",
        "age": 35
    }
]</code></pre>
<p>We have the <code>key</code> followed by an array <code>[...]</code> that contains three <code>key:value</code> pairs. This is very interesting because you can think of arrays in JSON as rows in a data frame. Going back to the full example, you can think of this as three keys (names of each slot) where each contains a 1 row data frame inside. Let’s try parsing this into R:</p>
<div class="sourceCode" id="cb301"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">json_str</span> <span class="op">&lt;-</span> <span class="st">'
{
    "president": [
        {
            "last_name": "Parlosi",
            "party": "Free thinkers",
            "age": 35
        }
    ],
    "vicepresident": [
        {
            "last_name": "Kantos",
            "party": "Free thinkers",
            "age": 52
        }
    ],
    "opposition": [
        {
            "last_name": "Pitaso",
            "party": "Everyone United",
            "age": 45
        }
    ]
}
'</span>

<span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">json_str</span>, simplifyDataFrame <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## $president
##   last_name         party age
## 1   Parlosi Free thinkers  35
## 
## $vicepresident
##   last_name         party age
## 1    Kantos Free thinkers  52
## 
## $opposition
##   last_name           party age
## 1    Pitaso Everyone United  45</code></pre>
<p>You get precisely a named list where each slot contains a data frame. Are you with me? So far so good. We have that JSON’s are <code>key:value</code> pairs and the value it self can be an array with other key/value pairs. So, with that idea in mind, you might get something like this:</p>
<pre><code>{
    "president": [
        {
            "last_name": "Parlosi",
            "party": "Free thinkers",
            "age": 35
        },
        {
            "last_name": "Stevensson",
            "party": "Free thinkers"
        }
    ],
    "vicepresident": [
        null
    ],
    "opposition": {
        "last_name": "Pitaso",
        "party": "Everyone United",
        "age": 45
    }
}</code></pre>
<p>Without looking further down, what you think will be the result of this in R? Study it and write it down. Let’s look at the result:</p>
<div class="sourceCode" id="cb304"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">json_str</span> <span class="op">&lt;-</span> <span class="st">'
{
    "president": [
        {
            "last_name": "Parlosi",
            "party": "Free thinkers",
            "age": 35
        },
        {
            "last_name": "Stevensson",
            "party": "Free thinkers"
        }
    ],
    "vicepresident": [
        null
    ],
    "opposition": {
        "last_name": "Pitaso",
        "party": "Everyone United",
        "age": 45
    }
}
'</span>

<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">json_str</span><span class="op">)</span>
<span class="va">res</span></code></pre></div>
<pre><code>## $president
##    last_name         party age
## 1    Parlosi Free thinkers  35
## 2 Stevensson Free thinkers  NA
## 
## $vicepresident
## [1] NA
## 
## $opposition
## $opposition$last_name
## [1] "Pitaso"
## 
## $opposition$party
## [1] "Everyone United"
## 
## $opposition$age
## [1] 45</code></pre>
<p>Well, It has something we’ve never looked at before. It has:</p>
<ol style="list-style-type: decimal">
<li><p>A data frame for the first slot. That’s correct because the JSON contained an array with two sets of <code>key:value</code> pairs. That’s translatable to a data frame with two rows even though one of the two sets did not have a field for <code>age</code>.</p></li>
<li><p>An NA value since <code>null</code> is the way missing values are represented in JSON but notice that this <code>null</code> is in a JSON array so this is effectively a data frame with an <code>NA</code> value.</p></li>
<li><p>A named list. That’s right because there is no array structure (<code>[...]</code>) so <code>key:value</code> pairs are interpreted as a named list.</p></li>
</ol>
<p>If for some reason you were thinking, why is this important? Let me tell you that for much of the JSON you’ll find in the wild, you’ll see it becomes more and more convoluted to read as it becomes more nested. You’ll need to learn to use your subsetting skills to actually convert the data into the format that you want. For example, you might want to convert the existing <code>opposition</code> slot into a data frame because the array structure was missing (<code>[...]</code>):</p>
<div class="sourceCode" id="cb306"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span><span class="op">$</span><span class="va">opposition</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">opposition</span><span class="op">)</span>
<span class="va">res</span></code></pre></div>
<pre><code>## $president
##    last_name         party age
## 1    Parlosi Free thinkers  35
## 2 Stevensson Free thinkers  NA
## 
## $vicepresident
## [1] NA
## 
## $opposition
##   last_name           party age
## 1    Pitaso Everyone United  45</code></pre>
</div>
<div id="the-enframe-unnest-strategy" class="section level2" number="14.2">
<h2>
<span class="header-section-number">14.2</span> The <code>enframe</code> + <code>unnest</code> strategy<a class="anchor" aria-label="anchor" href="#the-enframe-unnest-strategy"><i class="fas fa-link"></i></a>
</h2>
<p>And we’ve reached the most important objective of this chapter. Once we have this information, how can we combine it into a final data frame like this one:</p>
<pre><code>## # A tibble: 4 × 4
##   name          last_name  party             age
##   &lt;chr&gt;         &lt;chr&gt;      &lt;chr&gt;           &lt;int&gt;
## 1 president     Parlosi    Free thinkers      35
## 2 president     Stevensson Free thinkers      NA
## 3 vicepresident &lt;NA&gt;       &lt;NA&gt;               NA
## 4 opposition    Pitaso     Everyone United    45</code></pre>
<p>For each of the ‘categories’ (by this I mean, <code>president</code>, <code>vicepresident</code>, <code>opposition</code>), we concatenate all data frames into a single data frame which is much easier to read.</p>
<p>To do this, there’s a general strategy of combining two functions: <code>enframe</code> and <code>unnest</code>. <code>enframe</code> takes a named list and does two things. First, it extracts the <em>names</em> of each slot in the list and stores it in a column in a data frame. Secondly, it takes <strong>everything</strong> inside each slot and stores it in a <em>list-column</em>.</p>
<p>What is a list-column? It’s a column of class <em>list</em> that can contain different things for each row (if you remember, all columns in R must be of the same kind, either <code>numeric</code>, <code>character</code> or something else but there can’t be two types in the same column. With list-columns, this is an exception). In our example, the <strong>first row of this list-column is a data frame that has two rows</strong> (the data frame for <code>president</code>), the second row is an empty data frame with an <code>NA</code> value and the third is now a data frame since we altered the JSON manually (remember?). Here’s what the result of <code>enframe</code> would look like:</p>
<div class="sourceCode" id="cb309"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html">enframe</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 2
##   name          value       
##   &lt;chr&gt;         &lt;list&gt;      
## 1 president     &lt;df [2 × 3]&gt;
## 2 vicepresident &lt;lgl [1]&gt;   
## 3 opposition    &lt;df [1 × 3]&gt;</code></pre>
<p>The first column contains the names of the named list while the second column contains the list-column. The list column is telling you right away that it has two data frames and an empty slot. This is very useful for reading nested stuff because it gives you a high level overview of everything that you’re working with but how can we actually do something with this? We work with this using <code>unnest</code>. Contrary to <code>enframe</code>, <code>unnest</code> takes list-columns and ‘unpacks’ them into the common class of the list. Let me repeat that. <code>unnest</code> needs to be passed a list-column (the list-column can contain anything) and it will try to unpack it into whatever is the common class of all objects. If the all objects are of different classes (<code>data.frame</code>, <code>vectors</code>, etc..), then <code>unnest</code> will fail. However, if all objects within the list are of the same class, it will combine all of them into a proper column or ‘unpack’ it’s values.</p>
<p>That’s a somewhat convoluted explanation, and it’s totally fine if it’s not clear since there are many edge cases on how <code>unnest</code> works. Through the chapter we’ll focus on understanding how this function works.</p>
<p>Let’s unpack the <code>value</code> column using <code>unnest</code>:</p>
<div class="sourceCode" id="cb311"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html">enframe</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">value</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 4 × 4
##   name          last_name  party             age
##   &lt;chr&gt;         &lt;chr&gt;      &lt;chr&gt;           &lt;int&gt;
## 1 president     Parlosi    Free thinkers      35
## 2 president     Stevensson Free thinkers      NA
## 3 vicepresident &lt;NA&gt;       &lt;NA&gt;               NA
## 4 opposition    Pitaso     Everyone United    45</code></pre>
<p>Since all objects of the list-column were compatible (all were data frames with the same number of columns), <code>unnest</code> unpacks the column entirely to simply expand the data frame’s into one single data frame. A perfect example where <code>unnest</code> fails is when the different objects in the list are not easily mergeable. Say we use the same example as before but don’t convert the third slot into a data frame. We’ll that the JSON is parsed like this:</p>
<div class="sourceCode" id="cb313"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">json_str</span> <span class="op">&lt;-</span> <span class="st">'
{
    "president": [
        {
            "last_name": "Parlosi",
            "party": "Free thinkers",
            "age": 35
        },
        {
            "last_name": "Stevensson",
            "party": "Free thinkers"
        }
    ],
    "vicepresident": [
        null
    ],
    "opposition": {
        "last_name": "Pitaso",
        "party": "Everyone United",
        "age": 45
    }
}
'</span>

<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">json_str</span><span class="op">)</span>
<span class="va">res</span></code></pre></div>
<pre><code>## $president
##    last_name         party age
## 1    Parlosi Free thinkers  35
## 2 Stevensson Free thinkers  NA
## 
## $vicepresident
## [1] NA
## 
## $opposition
## $opposition$last_name
## [1] "Pitaso"
## 
## $opposition$party
## [1] "Everyone United"
## 
## $opposition$age
## [1] 45</code></pre>
<p>The first and second slot can be combined but the third is a named list. It’s not clear how it can be combined. <code>unnest</code> will tell you that when you try to unpack it:</p>
<div class="sourceCode" id="cb315"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html">enframe</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">value</span><span class="op">)</span></code></pre></div>
<pre><code>## Error:
## ! Can't combine `..1` &lt;data.frame&gt; and `..3` &lt;list&gt;.</code></pre>
<p>It says exactly that: the first slot is a data frame and the third slot is a list. It can’t find a way to combine them. The main problem you’ll encounter with JSON’s is that you’re trying to parse some JSON that has many nested arrays and some of these arrays are not compatible for unnesting so you’ll have to submerge yourself into these nested arrays and fix whatever data you want to extract.</p>
</div>
<div id="accessing-deeply-nested-jsons" class="section level2" number="14.3">
<h2>
<span class="header-section-number">14.3</span> Accessing deeply nested JSONs<a class="anchor" aria-label="anchor" href="#accessing-deeply-nested-jsons"><i class="fas fa-link"></i></a>
</h2>
<p>Suppose that as part of a research project, you’ve recently been granted access to the API of a company. You’re interested in studying the relationship between the geo-location of clients, their shopping patterns and their social class. Once they grant you access to their private API, the endpoint that returns the geo location for each client returns a JSON like the one below. You use <code>fromJSON</code> to parse it and here is what you get:</p>
<div class="sourceCode" id="cb317"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">json_str</span> <span class="op">&lt;-</span> <span class="st">'
{
    "client1": [
        {
            "name": "Kurt Rosenwinkel",
            "device": [
                {
                    "type": "iphone",
                    "location": [
                        {
                            "lat": 213.12,
                            "lon": 43.213
                        }
                    ]
                }
            ]
        }
    ],
    "client2": [
        {
            "name": "YEITUEI",
            "device": [
                {
                    "type": "android",
                    "location": [
                        {
                            "lat": 211.12,
                            "lon": 53.213
                        }
                    ]
                }
            ]
        }
    ]
}
'</span>

<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">json_str</span><span class="op">)</span>
<span class="va">res</span></code></pre></div>
<pre><code>## $client1
##               name                 device
## 1 Kurt Rosenwinkel iphone, 213.12, 43.213
## 
## $client2
##      name                  device
## 1 YEITUEI android, 211.12, 53.213</code></pre>
<p>Alright it seems two data frames were parsed, one for each client. Let’s pick one of these two to access the columns:</p>
<div class="sourceCode" id="cb319"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span><span class="op">$</span><span class="va">client1</span></code></pre></div>
<pre><code>##               name                 device
## 1 Kurt Rosenwinkel iphone, 213.12, 43.213</code></pre>
<p>Great, seems all was parsed correctly. Let’s paste “Device:” in front of each device just to make sure we don’t forget:</p>
<div class="sourceCode" id="cb321"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Device: "</span>, <span class="va">res</span><span class="op">$</span><span class="va">client1</span><span class="op">$</span><span class="va">device</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Device: list(type = \"iphone\", location = list(list(lat = 213.12, lon = 43.213)))"</code></pre>
<p>Ups, what? Oh, <code>device</code> column is not a character vector, it’s something like a list. Let’s explore it:</p>
<div class="sourceCode" id="cb323"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span><span class="op">$</span><span class="va">client1</span><span class="op">$</span><span class="va">device</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></code></pre></div>
<pre><code>##     type        location
## 1 iphone 213.120, 43.213</code></pre>
<p><code>device</code> is a list with a data frame inside. Let’s see what class is each of these columns to avoid the same mistake:</p>
<div class="sourceCode" id="cb325"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">client1</span><span class="op">$</span><span class="va">device</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">class</span><span class="op">)</span></code></pre></div>
<pre><code>## $type
## [1] "character"
## 
## $location
## [1] "list"</code></pre>
<p><code>location</code> is also a list. Let’s look at what’s inside:</p>
<div class="sourceCode" id="cb327"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span><span class="op">$</span><span class="va">client1</span><span class="op">$</span><span class="va">device</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">location</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></code></pre></div>
<pre><code>##      lat    lon
## 1 213.12 43.213</code></pre>
<p>Alright, this is a general pattern. Whenever <code>fromJSON</code> encounters an array within an array, it converts each one to a data frame. The problem is that these are recurrent data frames inside data frames and so on. It’s difficult to assess where to stop and this is a good example where <code>unnest</code> is very handy. Here’s how we could fix this:</p>
<div class="sourceCode" id="cb329"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span><span class="op">$</span><span class="va">client1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">device</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">location</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 4
##   name             type     lat   lon
##   &lt;chr&gt;            &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;
## 1 Kurt Rosenwinkel iphone  213.  43.2</code></pre>
<p>Let’s apply our general <code>enframe</code> + <code>unnest</code> strategy but applying <code>unnest</code> as many times as we need:</p>
<div class="sourceCode" id="cb331"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_res</span> <span class="op">&lt;-</span>
  <span class="va">res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html">enframe</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"client"</span><span class="op">)</span>

<span class="va">all_res</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   client  value       
##   &lt;chr&gt;   &lt;list&gt;      
## 1 client1 &lt;df [1 × 2]&gt;
## 2 client2 &lt;df [1 × 2]&gt;</code></pre>
<p>Let’s unpack <code>value</code>:</p>
<div class="sourceCode" id="cb333"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 3
##   client  name             device      
##   &lt;chr&gt;   &lt;chr&gt;            &lt;list&gt;      
## 1 client1 Kurt Rosenwinkel &lt;df [1 × 2]&gt;
## 2 client2 YEITUEI          &lt;df [1 × 2]&gt;</code></pre>
<p>Again with <code>device</code>:</p>
<div class="sourceCode" id="cb335"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="st">"device"</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 4
##   client  name             type    location    
##   &lt;chr&gt;   &lt;chr&gt;            &lt;chr&gt;   &lt;list&gt;      
## 1 client1 Kurt Rosenwinkel iphone  &lt;df [1 × 2]&gt;
## 2 client2 YEITUEI          android &lt;df [1 × 2]&gt;</code></pre>
<p>Again with <code>location</code>:</p>
<div class="sourceCode" id="cb337"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="st">"device"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="st">"location"</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 5
##   client  name             type      lat   lon
##   &lt;chr&gt;   &lt;chr&gt;            &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;
## 1 client1 Kurt Rosenwinkel iphone   213.  43.2
## 2 client2 YEITUEI          android  211.  53.2</code></pre>
<p>There we go. That’s how you handle nested JSON’s in R. Beware that for this example, everything worked well because each nested object was an array that could be merged with other types but the real challenge in parsing JSON’s is when some nested object does not conform well when unpacking everything into the same structure.</p>
<p>JSON’s are not that hard but the main challenge is understanding how to combine everything into R data frames when a lot of nested arrays have different classes or shapes. Remember that whenever you try to unpack something, be sure to pay attention to whether the error is related to unmergeable classes or objects of different lengths.</p>
</div>
<div id="exercises-9" class="section level2" number="14.4">
<h2>
<span class="header-section-number">14.4</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-9"><i class="fas fa-link"></i></a>
</h2>
<ol style="list-style-type: decimal">
<li>Can you fix this JSON?</li>
</ol>
<div class="sourceCode" id="cb339"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://arxiv.org/abs/1403.2805">jsonlite</a></span><span class="op">)</span>

<span class="va">json_str</span> <span class="op">&lt;-</span> <span class="st">'
{
  "president": [
    {
      "last_name": Parlosi,
      "party": "Free thinkers",
      "age": 35,
    },
    {
      "last_name": "Stevensson",
      party: "Free thinkers"
    }
  ,
  "vicepresident": [null],
  "opposition" =
    {
      "last_name": "Pitaso",
      "party": "Everyone United",
      "age": 45
    }
}
'</span>

<span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">json_str</span><span class="op">)</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Here’s an excerpt of a deeply nested JSON. Can you parse it into R and unnest all columns as needed. Why can’t you do it? Can you manually change the code to fix it?</li>
</ol>
<div class="sourceCode" id="cb340"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">json_str</span> <span class="op">&lt;-</span> <span class="st">'
{
    "client1": [
        {
            "name": "Kurt Rosenwinkel",
            "device": [
                {
                    "type": "iphone",
                    "location": [
                        "213.12",
                        "43.213"
                    ]
                }
            ]
        }
    ],
    "client2": [
        {
            "name": "YEITUEI",
            "device": [
                {
                    "type": "android",
                    "location": [
                        213.12,
                        43.213
                    ]
                }
            ]
        }
    ]
}
'</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Say after parsing a JSON you get a list like the one below. How can you transform it to be a data frame like the one below? Hint: you might need to explore the function <code><a href="https://purrr.tidyverse.org/reference/transpose.html">purrr::transpose</a></code>.</li>
</ol>
<div class="sourceCode" id="cb341"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">parsed_json</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>author <span class="op">=</span> <span class="st">"Cameron Gutkowski"</span>, genre <span class="op">=</span> <span class="st">"Ad"</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>author <span class="op">=</span> <span class="st">"Stuart Armstrong"</span>, genre <span class="op">=</span> <span class="st">"Sunt"</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>author <span class="op">=</span> <span class="st">"Kameron Grimes"</span>, genre <span class="op">=</span> <span class="st">"Eius"</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>author <span class="op">=</span> <span class="st">"Genoveva Hand"</span>, genre <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>author <span class="op">=</span> <span class="st">"Kobe Effertz"</span>, genre <span class="op">=</span> <span class="st">"Possimus"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 5 × 2
##   author            genre   
##   &lt;chr&gt;             &lt;chr&gt;   
## 1 Cameron Gutkowski Ad      
## 2 Stuart Armstrong  Sunt    
## 3 Kameron Grimes    Eius    
## 4 Genoveva Hand     A       
## 5 Kobe Effertz      Possimus</code></pre>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="what-is-a-restful-api.html"><span class="header-section-number">13</span> What is a RESTful API?</a></div>
<div class="next"><a href="case-study-grabbing-data-from-a-public-api.html"><span class="header-section-number">15</span> Case Study: grabbing data from a public API</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#what-you-need-to-know-about-json"><span class="header-section-number">14</span> What you need to know about JSON</a></li>
<li><a class="nav-link" href="#your-first-json-example"><span class="header-section-number">14.1</span> Your first JSON example</a></li>
<li><a class="nav-link" href="#the-enframe-unnest-strategy"><span class="header-section-number">14.2</span> The enframe + unnest strategy</a></li>
<li><a class="nav-link" href="#accessing-deeply-nested-jsons"><span class="header-section-number">14.3</span> Accessing deeply nested JSONs</a></li>
<li><a class="nav-link" href="#exercises-9"><span class="header-section-number">14.4</span> Exercises</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/cimentadaj/dataharvesting/tree/main/book/blob/main/13-intro_json.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/cimentadaj/dataharvesting/tree/main/book/edit/main/13-intro_json.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Data Harvesting with R</strong>" was written by Jorge Cimentada. It was last built on 2022-12-23.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
