<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>14 Case study: Exploring the Amazon API | Data Harvesting with R</title>
<meta name="author" content="Jorge Cimentada">
<meta name="description" content="Amazon, one of the largest e-commerce website on the web, has many APIs. Some of these are open to the public while others are used internally. In this case study we’ll be exploring the internal...">
<meta name="generator" content="bookdown 0.26 with bs4_book()">
<meta property="og:title" content="14 Case study: Exploring the Amazon API | Data Harvesting with R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://cimentadaj.github.io/dataharvesting/case-study-exploring-the-amazon-api.html">
<meta property="og:description" content="Amazon, one of the largest e-commerce website on the web, has many APIs. Some of these are open to the public while others are used internally. In this case study we’ll be exploring the internal...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="14 Case study: Exploring the Amazon API | Data Harvesting with R">
<meta name="twitter:description" content="Amazon, one of the largest e-commerce website on the web, has many APIs. Some of these are open to the public while others are used internally. In this case study we’ll be exploring the internal...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/_Lato-0.4.1/font.css" rel="stylesheet">
<link href="libs/_Roboto%20Mono-0.4.1/font.css" rel="stylesheet">
<link href="libs/_Montserrat-0.4.1/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/str_view-0.1.0/str_view.css" rel="stylesheet">
<script src="libs/str_view-binding-1.4.0/str_view.js"></script><link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
<script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
         (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-99618359-1', 'auto');
     ga('send', 'pageview');

    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h2>
        <a href="index.html" title="">Data Harvesting with R</a>
      </h2>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Welcome</a></li>
<li class="book-part">Webscraping</li>
<li><a class="" href="primer-webscraping.html"><span class="header-section-number">2</span> A primer on Webscraping</a></li>
<li><a class="" href="data-formats-for-webscraping.html"><span class="header-section-number">3</span> Data Formats for Webscraping</a></li>
<li><a class="" href="regex.html"><span class="header-section-number">4</span> What you need to know about regular expressions</a></li>
<li><a class="" href="xpath-chapter.html"><span class="header-section-number">5</span> What you need to know about XPath</a></li>
<li><a class="" href="spanish-school.html"><span class="header-section-number">6</span> Case study: Scraping Spanish school locations from the web</a></li>
<li><a class="" href="automating-scripts.html"><span class="header-section-number">7</span> Automating Web Scraping Scripts</a></li>
<li><a class="" href="scraping-javascript-based-website.html"><span class="header-section-number">8</span> Scraping JavaScript based website</a></li>
<li><a class="" href="ethical-issues.html"><span class="header-section-number">9</span> Ethical issues in Web Scraping</a></li>
<li class="book-part">APIs</li>
<li><a class="" href="intro-apis.html"><span class="header-section-number">10</span> Introduction to REST APIs</a></li>
<li><a class="" href="primer-apis.html"><span class="header-section-number">11</span> A primer on APIs</a></li>
<li><a class="" href="a-dialogue-between-computers.html"><span class="header-section-number">12</span> A dialogue between computers</a></li>
<li><a class="" href="json-chapter.html"><span class="header-section-number">13</span> What you need to know about JSON</a></li>
<li><a class="active" href="case-study-exploring-the-amazon-api.html"><span class="header-section-number">14</span> Case study: Exploring the Amazon API</a></li>
<li><a class="" href="automating-api-programs-real-time-bicycle-data.html"><span class="header-section-number">15</span> Automating API programs: real-time bicycle data</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/cimentadaj/dataharvesting">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="case-study-exploring-the-amazon-api" class="section level1" number="14">
<h1>
<span class="header-section-number">14</span> Case study: Exploring the Amazon API<a class="anchor" aria-label="anchor" href="#case-study-exploring-the-amazon-api"><i class="fas fa-link"></i></a>
</h1>
<p>Amazon, one of the largest e-commerce website on the web, has many APIs. Some of these are open to the public while others are used internally. In this case study we’ll be exploring the internal databases from Amazon through a fake example of their API. This API should be somewhat familiar to you because it’s the one we used in chapter <a href="intro-apis.html#intro-apis">10</a>. If you remember correctly, the API can be launched with the function <code><a href="https://rdrr.io/pkg/scrapex/man/api_amazon.html">api_amazon()</a></code> from the <code>scrapex</code> package.</p>
<p>Before we begin, let’s load all the package we’ll use in the chapter:</p>
<div class="sourceCode" id="cb326"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">scrapex</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr2.r-lib.org">httr2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></code></pre></div>
<p>Let’s launch the API:</p>
<div class="sourceCode" id="cb327"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">az_api</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scrapex/man/api_amazon.html">api_amazon</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">## [1] "Visit your REST API at http://localhost:9614"</span>
<span class="co">## [1] "Documentation is at http://localhost:9614/__docs__/"</span></code></pre></div>
<p>The print out of <code>api_amazon</code> tells us the URL that we have to visit to access the documentation of the API. Pretty much every time you begin working with an API, you’ll begin by visiting the documentation, looking at what each endpoint does and webbing together the dots on how you can obtain the data you’re looking for.</p>
<p>Let’s look at the documentation for hints of how this API works:</p>
<div class="inline-figure"><img src="images/case_study_api_amazon/main_amazon_docs.png" width="100%" style="display: block; margin: auto;"></div>
<p>The API has 7 endpoints. The blue button on each endpoint tells us that <em>all</em> endpoints are <code>GET</code> endpoints. We don’t have any of the other request types we discussed in chapter <a href="a-dialogue-between-computers.html#type-requests">12.2</a>. This is important because depending on the type of request you might need to do additional things (for <code>POST</code> you’ll need to add a request body, for example). In this book we’ll only work with <code>GET</code> requests because this is the type of request you’ll typically encounter when gathering data. However, be aware the you might encounter other types of request out there in the wild.</p>
<p>The endpoints contains data on all sorts of data from Amazon: authors and books from Amazon Books, users who visited Amazon and how each of these users bought certain Amazon products. As you might be hinting, this is quite some sensitive data. Unless you work at Amazon, you’ll probably never have access to this. That’s when security comes in.</p>
<div id="tokens-and-security" class="section level2" number="14.1">
<h2>
<span class="header-section-number">14.1</span> Tokens and security<a class="anchor" aria-label="anchor" href="#tokens-and-security"><i class="fas fa-link"></i></a>
</h2>
<p>Let’s assume that you are a researcher at a university who has signed a contract with Amazon to do some research using their internal database. Amazon has granted you access to their internal APIs but every few days Amazon has forced you to log in to your Amazon account and extract a token that needs to be refreshed before making any requests to the API.</p>
<p>Why does Amazon do this? Because they want to make sure that no one else is accessing this data except you. The token is associated with your personal email and whenever you finalize using the token, it expires. The function <code>api_amazon</code> has a companion function <code>amazon_bearer_tokens</code> which returns valid tokens to make requests. In the real world you won’t have such a function; instead you’ll have to follow the security guidelines of the API you’re using to obtain your token. Let’s call <code>amazon_bearer_tokens</code> to obtain our valid token and save it in a variable:</p>
<div class="sourceCode" id="cb328"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">token</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scrapex/man/amazon_bearer_tokens.html">amazon_bearer_tokens</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">token</span>
<span class="co">## [1] "CctltpliQk"</span></code></pre></div>
<p>Tokens will usually look like that. These are randomly generated strings that the developers of the API will create for you. The next thing you might be thinking about is how do I use this token? Where should I specify it? This depends on the API. You’ll need to read the documentation and find where the token should be specified. For many APIs, the token needs to be set as a header (check out chapter <a href="primer-apis.html#primer-apis">11</a> for details on headers). More specifically, the token should be set under the header <code>Authorization</code> and must have the word <code>Bearer</code> in front of it. Let’s use <code>httr2</code>, the root URL of the API in <code>az_api</code> and the token to create a dummy request:</p>
<div class="sourceCode" id="cb329"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">main_api_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">az_api</span><span class="op">$</span><span class="va">api_web</span>, <span class="st">"/api/v1/amazon/"</span><span class="op">)</span>
<span class="va">header_token</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Bearer "</span>, <span class="va">token</span><span class="op">)</span>

<span class="va">req</span> <span class="op">&lt;-</span>
  <span class="va">main_api_path</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/request.html">request</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_headers.html">req_headers</a></span><span class="op">(</span>Authorization <span class="op">=</span> <span class="va">header_token</span><span class="op">)</span>

<span class="va">req</span>
<span class="co">## &lt;httr2_request&gt;</span>
<span class="co">## GET http://localhost:9614/api/v1/amazon/</span>
<span class="co">## Headers:</span>
<span class="co">## • Authorization: '&lt;REDACTED&gt;'</span>
<span class="co">## Body: empty</span></code></pre></div>
<p>The request shows that we’ve specified the root URL of the API (we are not pointing to a particular endpoint just yet) and that we’ve specified one <code>key=value</code> pair for the headers. This <code>key=value</code> pair is <code>Authorization</code> and it doesn’t show the token because it automatically detects this header is private so it won’t show it. That’s how we go from no request to a full dummy request ready to be performed.</p>
</div>
<div id="understand-amazon-books" class="section level2" number="14.2">
<h2>
<span class="header-section-number">14.2</span> Understanding Amazon Books<a class="anchor" aria-label="anchor" href="#understand-amazon-books"><i class="fas fa-link"></i></a>
</h2>
<p>The first endpoint of the Amazon API contains data on all the authors that belong to their Amazon Books product. The following two endpoints allow you to extract all the books they’ve written in the Amazon database as well as sample text from these books. Let’s see the details of the <code>authors</code> endpoint (first endpoint):</p>
<div class="inline-figure"><img src="images/case_study_api_amazon/authors_amazon_docs.png" width="100%" style="display: block; margin: auto;"></div>
<p>The endpoint does not require any parameters so it probably returns all the authors directly. Also, it’s a <code>GET</code> request so we don’t have to add any body to the request. The endpoint URL is <code>authors</code> so let’s add it to the previous request:</p>
<div class="sourceCode" id="cb330"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">req_res</span> <span class="op">&lt;-</span>
  <span class="va">req</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"authors"</span><span class="op">)</span>
  
<span class="va">req_res</span>
<span class="co">## &lt;httr2_request&gt;</span>
<span class="co">## GET http://localhost:9614/api/v1/amazon/authors</span>
<span class="co">## Headers:</span>
<span class="co">## • Authorization: '&lt;REDACTED&gt;'</span>
<span class="co">## Body: empty</span></code></pre></div>
<p>The <code>GET</code> request was updated with the endpoint URL and we’re ready to perform the request. Let’s make the request and checkout the response:</p>
<div class="sourceCode" id="cb331"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span>
  <span class="va">req_res</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">res</span>
<span class="co">## &lt;httr2_response&gt;</span>
<span class="co">## GET http://localhost:9614/api/v1/amazon/authors</span>
<span class="co">## Status: 200 OK</span>
<span class="co">## Content-Type: application/json</span>
<span class="co">## Body: In memory (217 bytes)</span></code></pre></div>
<p>The request was successful with a <code>200</code> status code. The content type is JSON so we can extract it with <code>resp_body_json</code> and set <code>simplifyVector = TRUE</code> to convert it directly to a data frame:</p>
<div class="sourceCode" id="cb332"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span>simplifyVector <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">##              author    genre</span>
<span class="co">## 1 Cameron Gutkowski       Ad</span>
<span class="co">## 2  Stuart Armstrong     Sunt</span>
<span class="co">## 3    Kameron Grimes     Eius</span>
<span class="co">## 4     Genoveva Hand        A</span>
<span class="co">## 5      Kobe Effertz Possimus</span></code></pre></div>
<p>There we go, great! Amazon Books has five authors each one writing in a unique genre (no repetitions). Note that this data and all other examples shown in this chapter are completely made up! Don’t try to interpret these names or numbers as anything other than illustrative examples.</p>
<p>Alright, so we have the names of the authors. Let’s extract what books they’ve written. We can go back to the documentation and read the details on this endpoint:</p>
<div class="inline-figure"><img src="images/case_study_api_amazon/books_amazon_docs.png" width="100%" style="display: block; margin: auto;"></div>
<p>This endpoint’s URL is <code>books</code> and requires two parameters: <code>author</code> and <code>genre</code>. Both parameters are expected to be strings (can be seen in the documentation just below the names of the parameters) and both are <em>required</em>. How do we specify this in R? We’ll need to add the URL path to <code>books</code> and set the query parameters with <code>req_url_query</code>. Let’s explore the author <code>Stuart Armstrong</code> that writes in the genre <code>Sunt</code>:</p>
<div class="sourceCode" id="cb333"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">req_res</span> <span class="op">&lt;-</span>
  <span class="va">req</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"books"</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_query</a></span><span class="op">(</span>author <span class="op">=</span> <span class="st">"Stuart Armstrong"</span>, genre <span class="op">=</span> <span class="st">"Sunt"</span><span class="op">)</span>

<span class="va">req_res</span>
<span class="co">## &lt;httr2_request&gt;</span>
<span class="co">## GET</span>
<span class="co">## http://localhost:9614/api/v1/amazon/books?author=Stuart%20Armstrong&amp;genre=Sunt</span>
<span class="co">## Headers:</span>
<span class="co">## • Authorization: '&lt;REDACTED&gt;'</span>
<span class="co">## Body: empty</span></code></pre></div>
<p>You’ll notice two things. First, the base URL of the <code>GET</code> request was added and secondly, the query parameters were added to the URL. I strongly advise users to use functions such as <code>req_url_query</code> to add parameters instead of creating the URL manually because <code>httr2</code> takes care of translating spaces and other special characters (these are all the <code>%20</code> symbols in the URL) automatically. Let’s perform the request and directly extract the result with <code>resp_body_json</code>:</p>
<div class="sourceCode" id="cb334"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op">&lt;-</span>
  <span class="va">req_res</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span>simplifyVector <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">resp</span>
<span class="co">## # A tibble: 5 × 10</span>
<span class="co">##   id_book title author genre description isbn  image published publisher user_id</span>
<span class="co">##     &lt;int&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;int&gt;</span>
<span class="co">## 1     970 I ev… Stuar… Sunt  Dodo said,… 9798… http… 1993-11-… Sequi Et      319</span>
<span class="co">## 2     970 I ev… Stuar… Sunt  Dodo said,… 9798… http… 1993-11-… Sequi Et      471</span>
<span class="co">## 3     970 I ev… Stuar… Sunt  Dodo said,… 9798… http… 1993-11-… Sequi Et      187</span>
<span class="co">## 4     970 I ev… Stuar… Sunt  Dodo said,… 9798… http… 1993-11-… Sequi Et      918</span>
<span class="co">## 5     970 I ev… Stuar… Sunt  Dodo said,… 9798… http… 1993-11-… Sequi Et      692</span></code></pre></div>
<p>You might be thinking something like this right now:</p>
<blockquote>
<p>Hmm, that’s weird, it looks like <code>Stuart Armstrong</code> has written the same book five times. Looks like an error in the database.</p>
</blockquote>
<p>There’s no error in the database! That’s because the column <code>user_id</code> is showing us the users who have read this book. Aside from the author-book relationship, Amazon also has the book-customer relationship in these APIs. If we wanted to keep only the distinct books from this author we could exclude this column and use <code>distinct</code> to grab all unique books:</p>
<div class="sourceCode" id="cb335"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">user_id</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">## # A tibble: 1 × 9</span>
<span class="co">##   id_book title         author genre description isbn  image published publisher</span>
<span class="co">##     &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;    </span>
<span class="co">## 1     970 I ever was a… Stuar… Sunt  Dodo said,… 9798… http… 1993-11-… Sequi Et</span></code></pre></div>
<p>Alright so <code>Stuart Armstrong</code> has written only one book: “I ever was at in.”.</p>
<p>The next endpoint contains sample texts from the books of each author. Amazon stores this in their database to provide a sample of text in the description of the product. This might not be very interesting for your hypothetical research project but since you’re already inside the Amazon API, you might as well get familiar with it. Let’s look at the docs of this endpoint:</p>
<div class="inline-figure"><img src="images/case_study_api_amazon/texts_amazon_docs.png" width="100%" style="display: block; margin: auto;"></div>
<p>The endpoint needs one parameter: an author. Let’s take the dummy request, add the URL of this endpoint, add <code>Stuart Armstrong</code> as the author parameter, perform the request and extract the response as a data frame:</p>
<div class="sourceCode" id="cb336"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op">&lt;-</span>
  <span class="va">req</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"texts"</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_query</a></span><span class="op">(</span>author <span class="op">=</span> <span class="st">"Stuart Armstrong"</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span>simplifyVector <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">resp</span>
<span class="co">## # A tibble: 1 × 4</span>
<span class="co">##   id_books title             author           content                           </span>
<span class="co">##      &lt;int&gt; &lt;chr&gt;             &lt;chr&gt;            &lt;chr&gt;                             </span>
<span class="co">## 1      970 I ever was at in. Stuart Armstrong Dodo said, 'EVERYBODY has won, an…</span></code></pre></div>
<p>The sample text can be found in the column <code>content</code>. Here it is:</p>
<div class="sourceCode" id="cb337"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span><span class="op">$</span><span class="va">content</span>
<span class="co">## [1] "Dodo said, 'EVERYBODY has won, and all the unjust things--' when his eye chanced to fall upon."</span></code></pre></div>
<p>Awesome, we’ve explored quite a bit of the Amazon Books API. However, I purposely jumped quickly over the fact that we were able to access the users who read each of the books. In reality, we can use that information to access other endpoints.</p>
</div>
<div id="amazon-user-behavior" class="section level2" number="14.3">
<h2>
<span class="header-section-number">14.3</span> Amazon User Behavior<a class="anchor" aria-label="anchor" href="#amazon-user-behavior"><i class="fas fa-link"></i></a>
</h2>
<p>Take a look at the endpoint <code>products_users</code> in the documentation:</p>
<div class="inline-figure"><img src="images/case_study_api_amazon/products_users_amazon_docs.png" width="100%" style="display: block; margin: auto;"></div>
<p>The description states that in this endpoint you can <em>…access amazon’s products/users database</em>. This is interesting. This means that we can start to link user behavior through different endpoints. For example, we can take user <code>319</code> (see results of the request to the <code>books</code> endpoint in section <a href="case-study-exploring-the-amazon-api.html#understand-amazon-books">14.2</a> for all other user ids) and see which other products the user has bought on Amazon. Imagine the hidden relationships that you could uncover with the real data set: people who read certain books might have propensities to order certain products and you could improve their behavior and help them buy similar products.</p>
<p>This endpoint needs only one parameter, the user id. However, note that right below the parameter name it states that it is expecting an integer, not a string. Let’s keep that in mind when we specify the query parameters. Let’s construct the endpoint in R, make the request and extract the JSON as a data frame:</p>
<div class="sourceCode" id="cb338"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># TODO: If user_id has been specified in the request, the response must have that exact same user_id.</span>
<span class="va">resp</span> <span class="op">&lt;-</span>
  <span class="va">req</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"products_users"</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_query</a></span><span class="op">(</span>user_id <span class="op">=</span> <span class="fl">319</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span>simplifyVector <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">resp</span>
<span class="co">## # A tibble: 1 × 10</span>
<span class="co">##   product_id user_id ean          upc   image images net_price taxes price tags </span>
<span class="co">##        &lt;int&gt;   &lt;int&gt; &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;list&gt;     &lt;dbl&gt; &lt;int&gt; &lt;chr&gt; &lt;lis&gt;</span>
<span class="co">## 1         74     199 90623914056… 0236… http… &lt;df&gt;     298634.    22 3643… &lt;chr&gt;</span></code></pre></div>
<p>The resulting data frame contains a lot of details of the purchase such as the price, the image of the product as well as the associated tags of the product. However, we can’t really see the name of the product. That’s because there’s another endpoint called <code>products</code> that contains <em>…amazon’s product database</em>:</p>
<div class="inline-figure"><img src="images/case_study_api_amazon/products_amazon_docs.png" width="100%" style="display: block; margin: auto;"></div>
<p>This endpoint needs the <code>product_id</code> as an integer parameter. Let’s construct the request and finally get the products name and description:</p>
<div class="sourceCode" id="cb339"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op">&lt;-</span>
  <span class="va">req</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"products"</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_query</a></span><span class="op">(</span>product_id <span class="op">=</span> <span class="fl">74</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span>simplifyVector <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">resp</span>
<span class="co">## # A tibble: 1 × 3</span>
<span class="co">##      id name                       description                                  </span>
<span class="co">##   &lt;int&gt; &lt;chr&gt;                      &lt;chr&gt;                                        </span>
<span class="co">## 1    74 Quod qui sit vero vero ad. Mollitia ullam animi aut et perspiciatis et …</span></code></pre></div>
<p>There we go, the name of the product is Quod qui sit vero vero ad.. Quite a hassle eh? In the exercise section you’ll be asked to come up with a way to automate this entire process such that it’s very easy to check which products a user bought.</p>
<p>Finally, let’s explore the endpoint that details each user. Here are the docs from the API:</p>
<div class="inline-figure"><img src="images/case_study_api_amazon/users_amazon_docs.png" width="100%" style="display: block; margin: auto;"></div>
<p>The endpoint accepts two arguments but contrary to what we’ve seen so far, they are not required (they don’t have the two red words <em>required</em> that we’ve seen in the other endpoints). This means that you can specify either one or the other. Also note that both parameters are of different formats, <code>user_id</code> is an integer and <code>country</code> is a string. It’s not clear from the documentation exactly what type of information we’ll get because it states only <em>… access amazon’s user database</em> so we’ll need to make a request to see what it returns. Let’s construct it and extract the results specifying the <code>user_id</code> we’ve been working with so far:</p>
<div class="sourceCode" id="cb340"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op">&lt;-</span>
  <span class="va">req</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"users"</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_query</a></span><span class="op">(</span>user_id <span class="op">=</span> <span class="fl">319</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span>simplifyVector <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">resp</span>
<span class="co">## # A tibble: 1 × 4</span>
<span class="co">##   user_id countries macAddress        ip           </span>
<span class="co">##     &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;             &lt;chr&gt;        </span>
<span class="co">## 1     319 Gambia    73:AE:9F:86:CC:3A 127.77.16.104</span></code></pre></div>
<p>Wow, interesting, this user is from Gambia. Let’s try the same endpoint but specifying the <code>country</code> parameter to Germany:</p>
<div class="sourceCode" id="cb341"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op">&lt;-</span>
  <span class="va">req</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"users"</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_url.html">req_url_query</a></span><span class="op">(</span>country <span class="op">=</span> <span class="st">"Germany"</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://httr2.r-lib.org/reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span>simplifyVector <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://httr2.r-lib.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">resp</span>
<span class="co">## # A tibble: 2 × 4</span>
<span class="co">##   user_id countries macAddress        ip           </span>
<span class="co">##     &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;             &lt;chr&gt;        </span>
<span class="co">## 1     700 Germany   41:5B:FE:BF:21:B4 53.214.36.82 </span>
<span class="co">## 2     505 Germany   31:4E:07:78:81:09 78.141.68.137</span></code></pre></div>
<p>Two users in the database were located in Germany when using Amazon. As you can see, different endpoints return information that allow you access other information from other endpoints. In the end, APIs are like a series of branches that you can access on demand and some of the information you need to access one depends on the result of another one.</p>
<p>This case study was meant to give you a real world example of what talking to APIs means. APIs are interactive in nature and force you to learn how different endpoints work. Moreover, you’ll need to be creative in linking how information from one endpoint can help you get information from another one. In all honesty, most serious APIs out there will contain thorough documentation on how to get specific data sets you’re looking for but other APIs will require you to get to know some of the technical details before you start getting your hands dirty.</p>
</div>
<div id="exercises-11" class="section level2" number="14.4">
<h2>
<span class="header-section-number">14.4</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-11"><i class="fas fa-link"></i></a>
</h2>
<ol style="list-style-type: decimal">
<li>Which customers have read the most books from the database? Is there even a customer who has read the most? Your output should be all customers and the number of books they’ve read. Something like this:</li>
</ol>
<pre><code>##   101  102  187 ...
##   50   39   1   ...</code></pre>
<p>Hint: you need to loop over all authors, grab their books and count the users using <code>table</code></p>
<ol start="2" style="list-style-type: decimal">
<li>From all products that were bought (this means all users who bought any products), which are the most common tags? Similarly to the previous exercise, you need to end up with a vector with frequency of categories throughout all products like this one:</li>
</ol>
<pre><code>##   apperiam  at  quo ...
##   50        39  1   ...</code></pre>
<p>Hint: you need to reuse the extracted user ids from the previous exercise to loop over each one, extract the products they bought and count the tags of each product.</p>
<ol start="3" style="list-style-type: decimal">
<li>Can you create a function that when passed the ID of a user, returns the unique names of all the products that user bought?</li>
</ol>
<p>When ran, the function should return this:</p>
<div class="sourceCode" id="cb344"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">all_user_products</span><span class="op">(</span>user_id <span class="op">=</span> <span class="fl">187</span><span class="op">)</span>
<span class="co">## [1] "Impedit veniam corporis illo."</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Can you make a request to the <code>users</code> endpoint and provide both a <code>user_id</code> and the <code>country</code>? What does the status code mean? Can you look it up online? How can you fix this?</li>
</ol>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="json-chapter.html"><span class="header-section-number">13</span> What you need to know about JSON</a></div>
<div class="next"><a href="automating-api-programs-real-time-bicycle-data.html"><span class="header-section-number">15</span> Automating API programs: real-time bicycle data</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#case-study-exploring-the-amazon-api"><span class="header-section-number">14</span> Case study: Exploring the Amazon API</a></li>
<li><a class="nav-link" href="#tokens-and-security"><span class="header-section-number">14.1</span> Tokens and security</a></li>
<li><a class="nav-link" href="#understand-amazon-books"><span class="header-section-number">14.2</span> Understanding Amazon Books</a></li>
<li><a class="nav-link" href="#amazon-user-behavior"><span class="header-section-number">14.3</span> Amazon User Behavior</a></li>
<li><a class="nav-link" href="#exercises-11"><span class="header-section-number">14.4</span> Exercises</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/cimentadaj/dataharvesting/blob/main/book/14-case_study_api_amazon.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/cimentadaj/dataharvesting/edit/main/book/14-case_study_api_amazon.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Data Harvesting with R</strong>" was written by Jorge Cimentada. It was last built on 2023-01-31.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
